CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

PROJECT("rpg2kLib" CXX C)

ADD_SUBDIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/EASTL)
ADD_SUBDIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/pugixml/scripts)

SET(rpg2kLib_PATH ${CMAKE_CURRENT_SOURCE_DIR})
INCLUDE(${CMAKE_CURRENT_SOURCE_DIR}/rpg2kLib.cmake)

ADD_DEFINITIONS(${rpg2kLib_DEFINITIONS})
INCLUDE_DIRECTORIES(${rpg2kLib_INCLUDE_DIRS})
LINK_DIRECTORIES(${rpg2kLib_LIBRARY_DIRS})

AUX_SOURCE_DIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/rpg2k SRCS)
AUX_SOURCE_DIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/rpg2k/define SRCS)
ADD_LIBRARY(${PROJECT_NAME} STATIC ${SRCS})
TARGET_LINK_LIBRARIES(${PROJECT_NAME} ${rpg2kLib_LIBRARIES})

ADD_DEPENDENCIES(${PROJECT_NAME} "EASTL")

# test
ENABLE_TESTING()

INCLUDE(FindThreads)

FUNCTION(CXX_TEST target libs)
	ADD_EXECUTABLE(test/${target} ${CMAKE_CURRENT_SOURCE_DIR}/test/${target}.cxx)
	TARGET_LINK_LIBRARIES(test/${target}
		${rpg2kLib_LIBRARIES}
		${libs}
		"gtest"
	)
	IF(${UNIX})
		TARGET_LINK_LIBRARIES(test/${target} pthread)
	ENDIF()
	ADD_TEST(test/${target} test/${target})
	ADD_DEPENDENCIES(test/${target} ${PROJECT_NAME})

	SET(TEST_TARGET "${TEST_TARGET};test/${target}" PARENT_SCOPE)
ENDFUNCTION()

IF(${APPLE})
	LINK_DIRECTORIES(/opt/local/lib)
ENDIF()
CXX_TEST(encode "gtest_main")
CXX_TEST(model "gtest_main")
CXX_TEST(stream "gtest_main")
CXX_TEST(structure "gtest_main")

# borrowed from
# http://stackoverflow.com/questions/733475/cmake-ctest-make-test-doesnt-build-tests
ADD_CUSTOM_TARGET(check COMMAND ${CMAKE_CTEST_COMMAND} DEPENDS ${TEST_TARGET})
