CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

PROJECT("rpg2kLib" CXX C)

SET(EXECUTABLE_OUTPUT_PATH ${CMAKE_CURRENT_SOURCE_DIR}/bin)
SET(LIBRARY_OUTPUT_PATH ${CMAKE_CURRENT_SOURCE_DIR}/lib)

SET(rpg2kLib_PATH ${CMAKE_CURRENT_SOURCE_DIR})
INCLUDE(${CMAKE_CURRENT_SOURCE_DIR}/rpg2kLib.cmake)

ADD_DEFINITIONS(${rpg2kLib_DEFINITIONS})
INCLUDE_DIRECTORIES(${rpg2kLib_INCLUDE_DIRS})
LINK_DIRECTORIES(${rpg2kLib_LIBRARY_DIRS})

AUX_SOURCE_DIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/src SRCS)
ADD_LIBRARY(${PROJECT_NAME} STATIC ${SRCS})
TARGET_LINK_LIBRARIES(${PROJECT_NAME} ${rpg2kLib_LIBRARIES})

# test
ENABLE_TESTING()

INCLUDE(FindThreads)

FUNCTION(CXX_TEST target libs)
	ADD_EXECUTABLE(test_${target} ${CMAKE_CURRENT_SOURCE_DIR}/test/${target}.cxx)
	TARGET_LINK_LIBRARIES(test_${target}
		${rpg2kLib_LIBRARIES}
		${libs}
		"gtest"
	)
	TARGET_LINK_LIBRARIES(test_${target} ${CMAKE_THREAD_LIBS_INIT})
	ADD_TEST(
		NAME test_${target}
		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/test
		COMMAND ${EXECUTABLE_OUTPUT_PATH}/test_${target}
	)
	ADD_DEPENDENCIES(test_${target} ${PROJECT_NAME})
ENDFUNCTION()

SET(CXX_TEST_SOURCES "encode;model;stream;structure;")
FOREACH(i ${CXX_TEST_SOURCES})
	CXX_TEST(${i} "gtest_main")
ENDFOREACH()

# pugixml
ADD_SUBDIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/pugixml/scripts)
ADD_DEPENDENCIES(${PROJECT_NAME} "pugixml")
